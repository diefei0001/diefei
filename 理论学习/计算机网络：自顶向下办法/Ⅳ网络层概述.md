# 网络层概述
> 网络层的PDU是IP数据报
- 传输层的TCP报文段与UDP的数据报被封装成IP数据报，通过网络层的功能进行传输
.
---------------------------------------------------------------------------------------------
# 网络层的两个层面
> 网络层可以被分为数据层面和控制层面
- `数据层面`：对到来的分组进行处理和转发，是网络的实操层面
- `控制层面`：形成分组转发和处理的策略，是网络的理论层面
- 就像是一个加工厂，其必然有决定加工方法，制定加工规则的管理层，也有实施这些加工方法和加工规则的工人。
> 根据数据层面和控制层面的耦合程度，可以分为传统方式和SDN方式
> 传统方式的特点是高度耦合，垂直集成，分布独立控制，彼此互换信息
- 路由器的数据层面对分组的处理依赖控制层面提供的方法和策略。传统方式中，[控制层面与数据层面是高度耦合的，路由器需要为自己的数据平面维护控制平面，同时与其他路由器进行控制信息的交换]，这个[控制平面是嵌入路由器内部的]。网络中存在多个分布式的，彼此通信的控制平面网络。
- 所谓[垂直集成的，也就是硬件与适配硬件的操作系统，协议等绑定]
> SDN方式的特点是结构解耦，远程统一控制，可编程
-  SDN，软件定义网络，[存在一个集中式的统一控制平面调度中心——SDN控制器对网络中的数据平面进行远程管理]。[控制平面和数据平面是解耦的].
-  SDN[通过北向接口允许编程网络应用控制数据流向，进而使整个网络可编程]
-  SDN本质是[构建一个以网络应用为核心的，集成网络操作系统，分组交换机，分组操作软件，网络协议的创新的，开放式的，可编程的水平框架，而不像传统方式转发硬件与软件，协议所绑定那样僵化和封闭]
.
---------------------------------------------------------------------------------------------
# 路由和转发
> 网络层提供转发和路由两大功能
- 我们在概论中讲过网络层的路由和转发功能。如今我们进行更为详细的讨论。
  - 路由：[决定分组从发送主机到目标接收主机的路径]
  - 转发，[将分组从路由器的输入接口转发到合适的输出接口]
> 转发是是发生在路由器局部的，而路由是基于网络全局而言的
- 我们进行简单的类比。假设我们要从北京坐高铁到香港，那么在到达北京西站时，我们规划从北京西坐到上海东，再从上海东做到深圳北，再从深圳北坐到香港西九龙。这个规划是路由。而到了上海东高铁站后后，从高铁站哪个口出站，从哪个口转站，这是转发。
> 转发是数据层面实现的唯一功能，而路由在控制层面实现
## 转发信息
> 路由表是传统路由器中，控制平面和数据平面的沟通桥梁，其本质是地址与接口的映射表
- 在传统模式中，主要依靠[传统路由器的控制平面（各种路由算法协议）生成路由表，数据平面根据路由表对分组进行处理，实现分组转发。]
> 流表是SDN分组交换机中，控制平面和数据平面的沟通桥梁
- 在SDN模式中，则是通过SDN路由器实现，[SDN上运行着SDN操作系统，其通过各种管理软件，生成流表，通过南向接口分发给各个路由器，路由器根据流表的字段识别对分组执行的操作（action）(不止是转发！）)]
.
---------------------------------------------------------------------------------------------
# 网络层提供的网络服务模型
> 网络服务模型定义了网络层向上层提供的服务特性和承诺，可以分为虚电路和数据报两种模式
## 虚电路网络
> 虚电路是类似于电路交换技术，在数据传输前建立端系统之间的逻辑连接，其核心是面向连接，路径预建立、状态维护、VCID标识。
- 虚电路是网络中的专线，虚电路实际上就是将端系统A和B之间分组路由和转发所涉及到的`路由器都提前预订`，路线上的`转发节点都维护双方的通信状态`，分组`只需要携带身份标识——VCID`(虚电路标识符)，路由器通过VCID识别分组，实现快速转发
- 也就是说，虚电路相当于在A，B两端套了个管道，[每个分组走的路径都是一样的]，不难理解的是，其可以保证分组在众多网络节点的转发中，维持有序性和稳定性。
## 数据报网络
> 数据报网络不建立端到端的特定连接，其核心是无连接，无状态、独立路由、尽力而为
- 数据报网络要求`分组携带完整的目标ip地址`，`每个节点为每个分组独立计算下一跳`，其算法`由控制平面全权决定，而与上一个分组无关`，因此是无状态的。
- 可想而知，[A到B的分组不一定走一样的顺序，自然不能保证分组有序到达，甚至存在分组丢失]，因此数据报网络是尽力而为的。
> 网络层使用数据报网络模型
- 虚电路看起来似乎有不得不选的理由，但是其代价不比其优点少。由于我们是自顶向下地学习，我们知道网络层并没有提供可靠数据传输，这个功能由传输层提供。这是因为网络设计存在`端到端原则`：
- [将复杂的功能（如可靠传输、顺序控制）放在网络边缘（终端主机）实现，而不是放在网络核心（路由器）。核心网络只做最简单的任务：尽力转发数据包。这使得核心路由器极其简单、高效、易于维护和扩展。]
- 讲白了，[网络层涉及的是网络核心部分，而核心部分追求的是稳定，兼容，简洁],就像是设计一个操作系统，你不会把各种乱七八糟的东西都在内核层面实现，这是一样的道理\
.
---------------------------------------------------------------------------------------------
# 路由器的通用体系结构
> 路由器的结构可以分为输入端口，输出端口，交换部分，路由选择控制器
.
---------------------------------------------------------------------------------------------
# 分组输入输出
> 路由器的端口包含物理，链路，网络三层的封装和解封装功能
- 路由器的交换功能是全双工的，也就是说，[输入端口同时也具有输出端口的功能]。分组到达路由器，会被解封装至网络层。获取各层的`首部字段。`
> 路由器在输入输出端口维护一个缓冲队列，以解决端口瞬间速率与交换部分速率不匹配的问题
- 我们之前在TCP中提及过一个TCP HOL blocking的问题，与之类似的，路由器也存在HOL blocking问题，当[输入端口的第一个分组的输出端口被占用，其需要在输入端口等待]。
- [排队带来延迟，输入输出端口的缓冲区溢出带来分组丢失]
> 输入端口和输出端口的队列管理通常都包含优先级策略
- 输入和输出端口的队列会[根据不同来源的分组实施不同的优先级策略]，例如时延敏感的流量会被优先传输。
## 输入输出调度
### 单队列
> 单队列使用FIFO策略按照到达顺序进行调度
- FIFO实现简单，但是容易`导致HOL阻塞`，`缺乏QoS控制`。
### 多队列
> 基于优先级的多队列，常采用优先级类优先进行调度
- 根据数据包的优先级标记（如802.1p VLAN Tag, IP头中的DSCP/ToS字段，MPLS EXP）将其分类到不同的优先级队列中（例如：高、中、低）。
> 基于优先级的调度算法有SP，RR,WFQ，WRR等
- `SP(strict priority)`:[总是优先发送最高优先级非空队列中的包，但是低优先级队列会出现饿死的情况]
- `RR(round robin)`:[依次轮流为每个非空队列服务一次（发送一个包或一个固定量）。]
- `WRR（weighted round robin）`:[每个队列分配一个权重（Weight）。权重高的队列在轮询周期内获得的服务次数（或服务量）更多。]
### 丢弃策略
> 丢弃策略有：tail drop，priority，random三种
- tail drop就是最晚到来的被丢弃，priority按照优先级来丢弃，random则是运气差的被丢弃
.
---------------------------------------------------------------------------------------------
# 分组交换
> 交换结构的交换速率应该是输入链路的速率的N倍
- 假设有N条输入链路，那么交换结构的速率至少是单条链路的N倍才不会造成瓶颈
## 路由转发模式
> 基于内存的转发，指在CPU控制下，通过内存转发
- [只有一个共享的中央内存池]，所有到达输入端口的[数据包首先被复制到该共享内存中]，[中央处理器根据转发表查找每个包的目标输出端口]。最后，[数据包从共享内存复制到目标输出端口的缓冲区并发送出去]
- [缺陷是CPU和内存带宽影响整体速率，延迟]
*原理：*
![alt text](D:\Github code\diefei\Markdown素材库\Markdown 素材\通过内存交换.png)
> 基于总线的转发，指通过共享总线进行转发
- 设备内部[有一条共享的高速总线],输入端口将数据包[放到总线上广播]。所有[输出端口监听总线，但只有目标端口会接收并缓存该包]。需要`仲裁机制`解决多个输入端口争用总线的冲突。
- [缺陷是多个端口竞争总线，且存在HOLB的问题]
*原理*
![alt text](D:\Github code\diefei\Markdown素材库\Markdown 素材\基于总线的转发.png)
> 基于互联网络的交换
- 使用`专用硬件互连结构`在输入/输出端口间建立`并行通路`,常见的有榕树网络，`纵横网络（cross bar）`
- [缺点是成本高，一般用于核心网络交换设备]
*原理*
![alt text](D:\Github code\diefei\Markdown素材库\Markdown 素材\基于互联网络的转发.png)
---------------------------------------------------------------------------------------------


