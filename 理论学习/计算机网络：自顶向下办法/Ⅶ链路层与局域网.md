# 链路层概述
## 链路层服务
> 链路层通过链路实现以帧的形式在相邻两个物理节点之间传递数据
- 首先，`节点`指的是广义的网络通信设备，例如交换机，路由器，端系统等，`链路`则是连接两点的物理介质，有线或无线。链路层相较于其他层，其提供的服务是物理的，而不是逻辑的。因为其[依赖物理通信信道]。因此两个节点必须是相连的。
> 帧是链路层的PDU，将ip数据报封装，加上帧头帧尾

> 对于不同的网络（基于地域范围划分），使用链路层的部分服务
1. [有线介质少用可靠数据传输，无线介质常用]
  例如对于局域网，其常用介质以太网线，错误率低，因此没有必要为了低概率事件在链路上实现可靠数据传输，但是对于出错率较高的无线网络，则需要可靠数据传输机制
2. [链路层存在网卡与网卡之间的流量控制,差错检测，错误纠正]
-
-------------------------------------------------------------------------------------------------
## 链路
> 链路可以分为点到点链路和多点链路
- [点到点的链路常用于长距离的广域连接（WAN），而在端系统密集的局域网（LAN），则常用多点链路]。打个类比就是，点到点的链路就像是高铁线路，其数量一定没有国道来得多。通常在城市之间修高铁，然后通过国道通往城市的各个区
> 链路层聚焦于多点链路的寻址和碰撞（Media Access Control）问题
- 在一个局域网中，寻址用于区分发给谁，MAC用于解决多个设备如何共享一个物理介质，避免碰撞。
> 碰撞指的是多台设备同时争抢一个物理介质
- 在早期的网络交换设备，例如集线器，其不隔离碰撞域，可能出现类似HOL B的问题，HOL B存在控制机制，而碰撞就是不存在控制机制，导致数据同时通过物理介质传递导致数据损坏。
> 链路层的功能在适配器上实现
- 链路层的一系列功能，都是在NIC上实现的。例如，[NIC中的MAC芯片实现了帧构造与帧接收，网卡驱动实现数据提取与传递]
-
------------------------------------------------------------------------------------------------- 
# 以太网(多点连接网络)
> 以太网是由多台主机星型连接交换设备（交换机/集线器），实现局域网内设备通信的技术
- 以太网是最常用的局域网技术，以至于以太网几乎成为局域网的同名词

## MAC地址
> MAC地址是48位的-分十六进制地址，是网卡的标识
- MAC地址是通过ROM固化的地址，理论上任意两个mac地址都不相同
> 制造商购入mac地址空间保证唯一性
- 每个厂商都会获得由IEEE分配的OUI代码，为24位，其靠后24位区分自家生产的网卡
> mac地址分为单播，组播，广播mac地址
- 广播地址全1；
- 单播地址第一个字节最低位为0；
- 组播地址第一个字节的最低位为1；
[注意讨论时单播，组播还是广播都是基于目的mac地址讨论的]
## 以太网交换机
> 以太网交换机是全双工，多对点，隔离碰撞域，不隔离广播域的二层分组交换机
- 全[双工指的是接收数据和发送数据可以同时进行]，[多对点指的是交换机内部同时连通多对独立接口]，与基于互联网络的路由交换部分类似。
> 以太网交换机通过自学习算法生成mac转发表，实现帧的转发

## 以太帧
> 以太帧的基本结构为：前导码，SFD，目标mac，源mac，长度/类型，802.1Q vlan标签，Data和填充，FCS
*帧头*
- `前导码`和`SFD`用于[物理层同步和帧起始定位]。
- `目标mac`和`源mac`[标识发送方和接收方]
- `802.1Q vlan`[用于虚拟局域网的标识]
- `长度/类型`[标识上层协议与Data的字节数]
*数据载荷*
- Data：最小46，最大1500，不足46需要填充，大于1500要分片
*帧尾*
- FCS：CRC-32循环冗余校验码，FCS不匹配则会丢弃帧

## 自学习
> 交换表的表项包含mac地址与接口的映射，条目有老化时间
- [存在老化时间的原因在于mac地址是平面的]，一个网卡可以接入不同的交换机接口，也可能被替换成另外一个网卡。
> 自学习算法：
  1. 收到主机A的新帧后登记，记录A帧的源mac和接收A帧的接口号
  2. 此时mac地址表内无对应目标主机B的mac地址的表项，因此被称为未知单播帧
  3. 交换机泛洪未知单播帧A
  4. 目的主机返回的响应帧B则是指定接口转发，因为A帧的源mac地址和接口已经被记录了
  5. 同时记录主机B帧的源mac和B帧的接口号
-------------------------------------------------------------------------------------------------
# 单点连接网络
> PPP是常见的点对点协议，常用于网络接入ISP，广域网路由器的互联。
## PPP协议构成
> PPP协议由链路控制协议（LCP）建立配置测试数据链路连接
- 协商，配置最大帧长（MRU）、认证协议（PAP/CHAP）、压缩选项等。
- 建立，维护，断开连接
> 网络层PDU被封装到PPP帧进行传输
PPP帧：
| 标志位 | 地址 | 控制 | 协议类型 | 数据 | FCS | 标志位 |
> 网络控制协议
- 为不同网络层协议独立配置参数（如IP地址分配）
-
-------------------------------------------------------------------------------------------------
# Vlan
## vlan概述
> vlan将主机划分为逻辑分组，用于划分广播域
- 由于交换机不隔离广播域，因此在主机数量较多的局域网中，巨大的广播域会带来广播风暴和潜在安全问题，通过虚拟局域网可以实现逻辑上的对广播域的隔离
> 同属于一个vlan的主机能够通信，不属于一个vlan的主机不能直接通信
- 值得说明的是，[vlan分组可以包含连接不同交换机的主机]。
## 交换机接口
> 交换机接口根据对vlan标签处理策略，可以分为access，trunk，hybrid接口
- *access*：
  [access是单vlan固定pvid的接口]
  入方向上，接收帧永不带标签，交换机会强制给帧打上access端口的pvid（缺省vlan id）
  出方向上，帧标签被脱离标签。
- *Trunk*：
  [Trunk控制多个vlan的流量的交流]
  入方向上，[可以接收带标签(Tagged)的帧]。交换机会根据帧中的 VLAN 标签确定其所属 VLAN。
  [也可以接收不带标签(Untagged)的帧]。交换机会根据该 Trunk 端口配置的 PVID (Native VLAN) 给该帧打上标签。
  出方向上，[首先Trunk只会放行允许的vlan流量]。如果帧是tagged的，则保留
  如果帧是pvid的，则剥离
- *hybrid*
  [hybrid是混合了access，turnk类型的接口]
- [入方向处理：]
  *接收带标签帧*
    检查 VLAN ID 是否在端口的 允许通过列表（通过 tagged 或 untagged 隐式定义）
    若允许 → 携带原标签进入交换机转发流程
    若禁止 → 直接丢弃
  *接收无标签帧*
    自动打上 PVID 指定的 VLAN 标签
    后续按该 VLAN 进行转发
    如果该 VLAN ID 在端口的 Untagged VLAN List 中，则移除 VLAN 标签后发送。
    如果该 VLAN ID 在端口的 Tagged VLAN List 中，则保留 VLAN 标签后发送。
    如果该 VLAN ID 既不在 Untagged 列表也不在 Tagged 列表中，则不会通过该 Hybrid 端口发送。
- 出方向处理：
## vlan原理
> vlan通过在以太网帧中添加802.1Q vlan字段来实现逻辑分组
- 交换机在内部维护一个 `VLAN 映射表`，记录[端口所属的VLAN以及学习到的MAC地址属于哪个VLAN。]，[确定vlan后，再查对应vlan下的mac地址表]，[最后查询vlan策略，对帧进行处理(tagged？untagged？)]
- 对于交换机来说，其[对帧进行转发处理本身就需要vlan标签]，因此对于不带vlan标签的，其会[根据配置的缺省VlanID（PVID）打默认标签]。
