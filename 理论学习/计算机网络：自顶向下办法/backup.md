# 多点访问协议（MAP）
> MAP协议解决多个节点如何使用共享信道的问题，其通过信道划分，随机访问，轮流来实现
- 我们首先来思考下，如何让多个节点共享信道呢？首先，可以[采用隔离的方式]，就像是将一条大的高速公路划分为多个车道一样。让数据使用信道的一小部分，这种方式称为`信道划分协议`
- 另外一个思想是，[对发送不设限制，而是定义如何从检测和从碰撞中恢复，]由于发送方随时可以使用信道，这种方式被称为`随机访问协议`
- 还有一种想法是，[轮流使用信道，通过控制器实现信道使用权的轮询],称为`轮流协议`
## 信道划分协议
> TDMA，FDMA,CDMA是常用的信号划分协议
- 我们在讲解电路交换技术的时候，提到过多路复用的两个技术：TDM和FDM，[TDMA和FDMA分别基于TDM和FDM实现。]
- 因为其基于TDM/FDM实现，因此其继承了该技术的缺点：[负载均衡时效率高，负载不均衡时效率低]
- CDMA是基于CDM实现的，[CDM通过编码技术将多个节点的数据进行编码区分，接收方知道该数据的解码方式]。打一个比方，CDMA就像不同的人使用不同的语言进行讲话

## 随机访问协议
### ALOHA
> 纯ALOHA，时隙ALOHA都是分布式的，随机的协议
- 纯ALOHA最简单粗暴，每个节点都随时发，如果发生冲突（发送前，和传输中），则每个节点独立随机一个等待时间后再发 
- 时隙ALOHA[将时间分为固定长度的时隙，节点只能在时隙开始时发送数据，根据固定概率p决定发或不发数据，直到出现其他节点都随机到不发，而自己随机到发时，时隙才有数据发送，如果大家都随机到不发，那么时隙空闲]
### CSMA
> CSMA（Carrier Sense Multiple Access）载波侦听多路访问的特点是先听先说
- CSMA 是一个有礼貌的协议，[节点在发送前先侦听信道是否空闲（“先听后说”）。如果空闲则发送；如果忙则等待。]
- 但是[CSMA仍然可能出现冲突，原因在于延迟]，节点A开始发送时，信号还没传到节点B，节点B可能误以为信道空闲也发送，导致在信道中间某处发生冲突。
### CSMA/CD
> CSMA/CD(CSMA with Collision Detection)在CSMD的基础上增加了冲突检测能力，其特点是边说边听
-[节点在发送过程中持续侦听信道]。如果[检测到冲突（信号异常），立即停止发送，并发送一个强化的的拥塞信号（JamSignal）通知所有节点发生了冲突。然后通过二进制指数退避算法决定等待的时间]
> 二进制指数退避算法
- 设定一个最大退避次数 k_max
- SlotTime 是一个关键的网络参数，通常略大于信号在最大网络距离上往返传播的延迟 + 其他处理时间（如冲突检测时间）。在传统以太网中通常是 512 位时间（51.2 μs @ 10 Mbps）。
- 当节点检测到冲突需要重传时：
  1. k = min(k + 1, k_max)（冲突计数器递增，但不超过上限）。
  2. 从整数集合` [0, 1, 2, ..., 2^k - 1]` 中随机均匀地选择一个整数 r。
  3. 退避时间 = r * SlotTime。
- 从这个算法我们能得出两个信息：[每个节点等待的时间是均匀分布]的。[随着碰撞次数的增多，等待时间的范围呈指数级增长，节点要更有耐心，],k小的时候，选中0的概率更大。其退避策略是`动态`,`自适应的`，而ALOHA是`静态`，`固定`的。[k增加反应了网络的负载更重，在负载更重的时候等待更长时间，在负载更轻的时候等待更短时间]
- [最大退避次数为等待时间设置了上界]。
- [随着k的增加，碰撞的概率更小，这个变小的趋势呈指数级的缩小]
### CSMA/CA
> CSMA/CA(CSMA with Collision avoidance)无法CD，因此CSMA/CA转而致力于尽最大可能避免冲突（CA）的发生,其特点是
> 无线链路的特性导致其不能边说边听。
- [无线链路的信号强度不断衰减，与距离的平方成反比一个节点],在发送时，其自身的发送信号强度会远大于从远处其他节点传来的信号强度，导致它无法在发送的同时可靠地侦听到微弱的、可能代表冲突的信号。
- [半双工限制：典型的Wi-Fi网卡在同一个频率上不能同时发送和接收]
> 隐藏终端问题,暴露终端问题（也是无法CD的原因
-  节点 A 和节点 C 都在节点 B 的通信范围内，但 A 和 C 彼此不在对方的通信范围内，导致A不知道C正在向B发送，导致冲突,称为`隐藏终端`
-  节点 C 向 D 发送数据。节点 B 在 C 的通信范围内（能听到 ），但不在 A 的范围内。节点 D 在 C 的通信范围内，但不在 B 或 A 的范围内。导致AB通信时，C无法与D通信，称为`暴露终端`
> CSMA/CA的工作原理
1. `物理载波侦听`
   节点使用其无线收发器实际监听信道上的物理信号强度。如果强度超过某个阈值，则认为信道忙。
2.  节点只有在持续侦听到信道空闲一个 DIFS 时间后，才能尝试发送数据或进入退避流程（IFS有SIFS，PIFS，DIFS三种）
3.  节点启动一个`退避定时器（Backoff Timer）`， 退避时间 = 随机值 *SlotTime
    - 随机值： 从 [0, CW] 区间内均匀随机选择一个整数（称为竞争窗口， Contention Window, CW）。[cw也是跟随网络情况动态调整的]
    - SlotTime： 一个固定时间单位，取决于物理层（如 802.11g/n 为 9μs 或 20μs）。
    - [每当信道空闲一个SlotTime，退避定时器就减1。如果信道变忙（物理或虚拟），退避定时器暂停。当信道再次持续空闲一个DIFS后，退避定时器恢复递减。当退避定时器减到0时，节点可以发送帧。]
4. 四次握手：
   接收方成功接收到一个单播数据帧后，必须[等待一个SIFS时间后，立即向发送方回复一个短小的ACK帧。]
   [发送方在竞争到信道后，先发送一个短小的RTS帧给接收方]。RTS 帧中包含本次通信（数据+ACK）所需的持续时间。
   [接收方收到RTS后，等待一个SIFS，回复一个短小的CTS帧]。CTS 帧也包含相同的持续时间信息（从 RTS 中复制）
   发送方收到 CTS 后，等待一个 SIFS，开始发送数据帧，收不到回到第二步重传
   [收方成功接收数据后，等待一个SIFS，回复ACK，成功则结束，失败回到第二步重传]
5. `虚拟载波侦听`
    Rts和Cts都是广播帧，因此其他节点收到后，会根据rts和cts创建NAV，NAV本质是个定时器，即使物理层侦听到信道空闲，只要` NAV > 0`，[节点也会认为虚拟信道忙。]
### CA与CD对比
- CD类似于我用你也用，大家都别用，通过二进制指数退避算法，决定谁先谁后。CA相当于我用你别用，通过指数退避算法决定接下来谁用，通过退避定时器，RTS和CTS四次握手，NAV机制保证我的使用不被干扰
- 四次握手与NAV主要是为了解决隐藏终端的问题，但其消耗大，因此只有在无线网络环境比较复杂的时候，才会使用。但是返回ACK是无论启用RTS/CRS机制与否，都需要，因为无线局域网需要链路层提供可靠数据传递。

## 轮询协议
> 令牌传递是常见的轮询协议
- 一个特殊的短帧（令牌）在逻辑环或物理环上的节点之间顺序传递。[只有持有令牌的节点才有权发送数据帧。] 发送完数据（或超时）后，节点将令牌传递给下一个节点。
## 链路层的差错检测和纠正
> 链路层通过CRC循环冗余校验实现差错检测
- 与checksum类似，我们不对CRC循环冗余校验的具体算法进行深入讲解，我们只需要知道其是[基于生成多项式的模2除法生成校验码，以太网用的是CRC-32]标准即可
> 链路层的纠正分为前向纠正和自动重传请求两种
- `前向纠正（FEC）`是通过添加`冗余纠错码`，接收方[通过解码实现自动定位与修复]；其典型代表是[广泛用于无线通信，光纤通信的里德·所罗门码，以及无线通信常用的LDPC码]
- 自动重传也就是我们在传输层学习过的ARQ（等停（rdt），GBN，SR）
> FEC和ARQ都是尽可能地增强信道的可靠性