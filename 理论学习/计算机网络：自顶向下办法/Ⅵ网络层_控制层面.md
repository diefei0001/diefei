# 路由选择算法
## 路由选择算法的概念
> 路由选择的目的是确定端到端通信的较好路径（路由序列）
- 这个较好，主要看聚焦于哪些指标，常见的聚焦指标有：
  `最短路径`： 跳数最少（经过的路由器最少）。
  `最低成本`： 链路成本总和最低（成本可能基于带宽、延迟、拥塞程度、货币费用等）。
  `最快路径`： 端到端延迟最小。
  `最大带宽`： 可用带宽最高的路径。
  `最可靠路径`： 历史故障率最低的路径。
> 路由选择计算的是子网到子网，而不是主机到主机之间的路径
- 主机发送数据的第一跳一定是子网路由器，同理，数据的最后一跳是出站网，因此我们可以将[路由视为决定子网到子网之间的较好路径]

## 静态路由
> 静态路由是网络管理员自行配置的路由表
- 静态路由的优点自然是性能消耗小，且时延小，缺点也很明显，人工配置的方式不适用于大规模复杂网络
- 一般用于：极小网络、默认路由、末梢网络、安全要求极高的特定路径。
## 动态路由
-  路由器`运行路由协议`，自动生成路由表（发现其他网络），计算最优路径并动态更新路由表。
### 距离矢量
> DV中，路由器只掌握以自身为中心的局部网络信息，并通过与邻居交换信息，不断迭代更新自身拥有信息
- 首先，我们来看什么是`距离`？我们之前提到过，`路由选择算法有其度量值`,也称为`代价`，可以是跳数，延迟，拥塞程度，[聚焦于什么度量值取决于网络管理者希望网络表现出何种特性]。
- `矢量`，指方向，也就是下一跳。
- 也就是说距离矢量其实可以被中译中为：[根据某个度量值而决定的下一跳路由器方向]。每个路由器对目标网络只维护 `(距离， 矢量)`
> DV中，每个路由器只维护自身直连网络，邻居路由器，邻居路由器告知的信息
- 邻居之间传递信息主要通过广播，[定期（如RIP每30秒）向所有邻居广播自己的整个路由表（或变化部分）]。这是DV协议的主要开销来源之一。
> DV的核心原理是分布式迭代、基于谣言传播（邻居通告）、局部最优决策
  1. [自动生成直连路由(C)]。这是路由表的基石
  2. [定期或触发式地向所有邻居广播自己的整个路由表]（或变化部分）,从而[获取非直连网络的信息]
  3. 路由器收到邻居的广播后，根据对每条路由信息进行`更新`：
            `D(me->Dest) = Min [ D(neighbor->Dest) + Cost(me->neighbor) ]`
                  新距离 = 邻居报告的距离 + 到该邻居的链路度量
  4. 如果新距离小于当前路由表中记录的距离，或者发现新网络，则更新路由表（下一跳设为该邻居，距离设为新距离）。
  5. 对同一目标且下一跳相同的路由，必须接受邻居的最新值（即使更差）
> DV的三大缺点：慢收敛，计数到无穷,临时环路
- [慢收敛指的是路由器之间信息的更新同步太慢]，这其实很好理解，因为信息是从远方口口相传的，而且必须等到通告广播的周期性触发。
- 所谓计数到无穷指的是，[距离值从故障发生前的有限值（如跳数=2）逐步增加到协议定义的无穷大（如RIP中跳数=16），最终判定目标不可达。]。例如在rip中，跳数被限制为16跳，超过16跳则被视为不可达。
- 临时环路指的是，数据包在路由器间循环转发，无法到达目的地，直到 TTL 减为 0 被丢弃
- 其中，[计数到无穷引发临时环路]，我们假设在这样一个拓扑中：
                         A——————————————B————————————————————C
- 假设AB的链路出错，B将A距离设置为∞，但是还没来得及通告，C的广播就已经到达B，B根据算法发现C提供的过时信息（A，2）更优，就将（A，∞）替换成（A，3）了。这样B就认为到达A的下一跳应该去往C，环路形成
- C 的路由表老化/更新，其从B中学习到D(A，4)，然后传递给B，导致B更新（A，5），然后陷入循环递增，最终导致该路由信息不可用
- [计数到无穷，临时环路的根本原因都是因为DV基于谣言传播，即路由器无条件信任邻居，且因为慢收敛性导致DV协议在收敛过程中无法保证一致性——部分路由器持有新信息，部分仍持旧信息，混合状态导致逻辑冲突。]
> DV通过水平分割，毒性逆转，抑制定时器等机制避免DV的缺陷
- 水平分割指的是，[从不将从某个邻居学到的路由信息，再通过接收该信息的接口通告回给那个邻居]
- 毒性逆转： [当检测到直连网络失效时，立即将该网络的距离设为∞并广播出去。]
- 当收到一条指示某目标网络不可达（距离=∞）的更新时，或自身发现某路由失效时，启动一个抑制定时器（通常数倍于更新周期，如RIP 180秒）。在定时器超时前：
    [忽略关于此网络的、来自任何邻居的、距离相同或更差的更新（防止旧信息干扰）。]
    [接受并处理关于此网络的、来自任何邻居的、距离更好的更新（新路径出现）。]

### 链路状态算法
> LS中，路由器掌握整个网络的完整拓扑结构
- 在LS中，路由器独立地根据这张完整的“网络地图”计算出到所有目的地的最短路径
> LS是基于链路状态的
- 链路状态指的是`邻居信息`和`链路代价`
> LS工作流程
1. `邻居发现`
    路由器启动后，首先通过在其直连接口上发送特殊的Hello包（例如OSPF中的Hello报文）来[识别哪些路由器是它的直接邻居]。Hello包通常包含路由器自身的ID。
2. `探测链路开销`
    路由器会[测量到每个邻居的链路开销（Cost）]。
3. `LAS洪泛`
    构建并[洪泛链路状态通告]（Link-State Advertisement, LSA）,将LSA存储进[链路状态数据库LSDB]
    LSA包括：
        a. 通告路由器ID（谁生成的这个LSA）
        b. 邻居路由器ID列表    
        c. [到每个邻居的链路开销]
        d. [LSA的序列号（用于新旧判断）]
        e. 生存时间（TTL，用于最终清除旧LSA）
        f. 其他特定协议信息（如区域ID）
4. `邻居验收`
   如果是新的，则存储并泛洪，如果是重复的，则忽略，如果是旧的，则回传自己的LSA
5. `Dijkstra算法`
    以LSDB数据库为支撑，执行Dijkstra算法，计算[到达目标网络的最短路径树]。
> LS通过可靠洪泛机制，确保路由器的LSDB都是相同的
- 这从根本上解决了DV的本质缺陷：收敛时间导致的路由器信息不一致的问题，避免了路由环路

# 路由选择协议
> RIP协议是基于DV算法的路由选择协议，OSPF协议是基于LS算法的路由选择协议
- 由于RIP协议存在较大缺陷，目前主流采用OSPF协议，因此只简单讲解ripv2协议
## RIPv2
- > RIP协议以跳数为度量，最大16跳
- > RIP协议通过UDP 520端口组播传递RIP路由表，v1则是广播
- 传递的RIP路由表为自己的直连网络与跳数
## OSPF协议

### OSPF工作过程————邻居发现
> OSPF 的Hello分组以组播的方式发送。组播地址为224.0.0.5，协议号字段为89
- 路由器维护邻居表，以10s为周期，发送hello分组，如果40s内无应答，则认为该路由器不可达
状态：`Down`→`Init `→` 2-Way`：收到邻居Hello包（包中明确列出自己的Router ID）
### OSPF工作过程————LSDB同步    
> Exstart状态
- [2-way是邻居关系的终点，是邻接关系的起点]， 建立邻居关系后，会进入到ExStart状态。
- 双方发送空内容的`DBD报文（Database Description）`,根据Router ID，确定`主从关系`
> Exchange状态
- 双方通过LSA头部列表，对比出缺失或过时的LSA
> Loading状态（按需请求完整LSA）
- 通过LSR，LSU，LSakck互换LSA，直到LSDB同步
> FUlL状态，标志形成邻接
-  在邻居基础上，成功完成LSDB同步（交换完整的LSA集合）的路由器对称为邻接。
### LSA类型
> LSA是OSPF信息的载体单元，描述路由器接口、链路、邻居、外部路由等
- Hello： 发现和维护邻居关系,协商参数（Area ID、Hello/Dead Interval、认证、网络掩码等）。
- Database Description (DBD / DD)： 在邻接关系建立过程中，[交换各自LSDB的摘要信息]（LSA头部列表）。
- Link State Request (LSR)： 在DBD交换后，[请求对方发送自己缺少的或更新的具体LSA内容]。
- Link State Update (LSU)： 包含一个或多个完整的LSA，用于`组播`[响应LSR请求或主动通告更新]
- Link State Acknowledgment (LSAck)： 用于[确认收到的LSU报文，确保LSA的可靠传输]。
 
## OSPF区域划分
> OSPF是分区动态路由
- 为了解决LS算法在大型网络中 LSDB 过大、SPF 计算频繁、洪泛开销大的问题，OSPF 引入了区域的概念。
> OSPF将一个AS划分为骨干部分（areo0）以及非骨干部分（Aero1 ，2，3）,非骨干区域一定要连接到骨干部分，分为`直连`和`虚链路连接`两种
- AERO 0 和其他AERO形成的是星型放射，避免环路。
> ABR是不同OSPF区域的出入口
- ABR实际上是一个OSPF非骨干部分的出入口，其将OPSP内子网的地址进行路由聚合，仅传递目标网络和cost给骨干部分，多个ABR接入骨干部分，从而实现数据从非主干部分转发到另一个主干部分。
> 区域内通信依赖Type 1，2LSA，区域间通信依赖Type3
- Type3只包含目标网络和到达目标网络的总开销
> ASBR将AS外部协议的路由表翻译成OSPF特有的 Type 5 External LSA
- TYPE5 LSA到达ABR就停止，改由ABR注入数据到OSPF非主干部分，ABR 添加LSA 4 到LSDB以告知内部设备ASBR的位置和到达ASBR位置的开销。
- 也就是说，ABR是子OSPF域与骨干域的中介，ASBR则维护整个OSPF域的边界。
